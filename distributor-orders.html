<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fresh Cart - Distributor Orders</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary-dark:#333333;--secondary-light:#f5f5f5;--card-bg:#ffffff;
      --text-dark:#222222;--text-light:#555555;--border-color:#dddddd;
      --font-heading:'Montserrat',sans-serif;--font-body:'Roboto',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--font-body);color:var(--text-dark);line-height:1.6;background-color:var(--secondary-light);display:flex}
    h1,h2,h3,h4{font-family:var(--font-heading)}
    .dashboard-wrapper{display:flex;min-height:100vh;width:100%}

    /* Sidebar */
    .sidebar{width:250px;background-color:var(--primary-dark);height:100vh;position:fixed;top:0;left:-250px;transition:left .3s ease-in-out;display:flex;flex-direction:column;box-shadow:2px 0 10px rgba(0,0,0,.2);z-index:1000}
    .sidebar.active{left:0}
    .logo{padding:2rem 1rem;text-align:center;color:var(--secondary-light);font-size:1.5rem;font-weight:bold}
    .main-nav ul{list-style:none;padding:0}
    .nav-item a{display:block;padding:1rem 2rem;color:var(--secondary-light);text-decoration:none;transition:background-color .2s;font-weight:500}
    .nav-item a.active,.nav-item a:hover{background-color:#555555}
    .logout-btn{width:100%;padding:1rem;background-color:#e0e0e0;color:var(--text-dark);border:none;cursor:pointer;font-size:1rem;font-weight:500;transition:background-color .2s}
    .logout-btn:hover{background-color:#cccccc}

    /* Header */
    .dashboard-header{position:fixed;top:0;left:0;width:100%;padding:1rem;background-color:var(--card-bg);box-shadow:0 2px 5px rgba(0,0,0,.1);z-index:1001;display:flex;align-items:center;justify-content:space-between}
    .hamburger-btn{font-size:2rem;cursor:pointer;color:var(--primary-dark);background:none;border:none;display:block}
    .header-title{font-size:1.5rem;color:var(--primary-dark)}

    /* Layout: list + receipt panel */
    .content-wrapper {
      flex-grow:1;
      display:grid;
      grid-template-columns: 2fr 1.2fr;
      gap:1.5rem;
      padding:2rem;
      padding-top:6rem;
      transition:margin-left .3s ease-in-out;
    }
    .sidebar.active ~ .content-wrapper {
      margin-left:250px;
    }

    .content-left {
      min-width:0;
    }
    .page-title{color:var(--primary-dark);margin-bottom:1.5rem}

    .search-filter-container{display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}
    .search-filter-container input,.search-filter-container select{flex:1;min-width:150px;padding:.75rem;border:1px solid var(--border-color);border-radius:8px;font-family:inherit}
    .search-filter-container input:focus,.search-filter-container select:focus{outline:none;border-color:var(--primary-dark)}
    .toggle-row{display:flex;gap:.5rem;margin-bottom:1.5rem}

    /* Buttons */
    .btn-primary{background-color:#454545;color:#fff;padding:.55rem 1.1rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s;font-size:.85rem}
    .btn-primary:hover{background-color:#222}
    .btn-secondary{background-color:var(--border-color);color:var(--text-dark);padding:.55rem 1.1rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s;font-size:.85rem}
    .btn-secondary:hover{background-color:#ccc}

    /* Orders grid */
    .order-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem}
    .order-card{background-color:var(--card-bg);padding:1.5rem;border-radius:16px;box-shadow:0 4px 10px rgba(0,0,0,.1);transition:transform .2s ease,box-shadow .2s ease}
    .order-card:hover{transform:translateY(-5px);box-shadow:0 6px 15px rgba(0,0,0,.15)}
    .order-header{display:flex;justify-content:space-between;align-items:center;font-weight:500}
    .order-status{padding:.25rem .75rem;border-radius:6px;font-weight:600;text-transform:capitalize;font-size:.9rem}
    .status-pending{background-color:#fff3e0;color:#e65100}
    .status-accepted{background-color:#e0e0e0;color:#000}
    .status-declined{background-color:#fce4ec;color:#ad1457}
    .status-shipped{background-color:#cfd8dc;color:#455a64}
    .status-delivered{background-color:#b0bec5;color:#37474f}
    .order-details{padding-top:1rem;border-top:1px dashed var(--border-color);margin-top:1rem}
    .action-buttons{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:1rem}

    /* Receipt / View items panel (on the right) */
    .receipt-panel {
      background-color:var(--card-bg);
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,.1);
      padding:1.5rem;
      min-height:200px;
    }
    .receipt-title {
      font-size:1.1rem;
      font-weight:600;
      margin-bottom:.5rem;
    }
    .receipt-meta {
      font-size:.9rem;
      color:var(--text-light);
      margin-bottom:.75rem;
    }
    .receipt-items {
      border-top:1px solid var(--border-color);
      margin-top:.75rem;
      padding-top:.75rem;
      max-height:320px;
      overflow-y:auto;
    }
    .receipt-row {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      font-size:.9rem;
      padding:.3rem 0;
    }
    .receipt-name {
      flex:1;
      margin-right:.5rem;
    }
    .receipt-meta-line {
      white-space:nowrap;
      font-variant-numeric:tabular-nums;
      color:var(--text-light);
    }
    .receipt-total {
      border-top:1px dashed var(--border-color);
      margin-top:.75rem;
      padding-top:.75rem;
      display:flex;
      justify-content:space-between;
      font-weight:600;
      font-size:.95rem;
    }

    @media (max-width:1024px){
      .content-wrapper {
        grid-template-columns:1fr;
      }
    }

    @media (max-width:768px){
      .sidebar{width:100%;left:-100%}
      .sidebar.active{left:0}
      .content-wrapper{padding:1rem;padding-top:5rem;margin-left:0}
      .sidebar.active ~ .content-wrapper{margin-left:0}
    }
  </style>
</head>
<body class="dashboard-page">
  <div class="dashboard-wrapper">
    <aside class="sidebar" id="sidebar">
      <div class="logo">Fresh Cart</div>
      <nav class="main-nav">
        <ul>
          <li class="nav-item"><a href="distributor-dashboard.html">Dashboard</a></li>
          <li class="nav-item active"><a href="distributor-orders.html">Orders</a></li>
          <li class="nav-item"><a href="distributor-products.html">Products</a></li>
          <li class="nav-item"><a href="distributor-payments.html">Payments</a></li>
          <li class="nav-item"><a href="distributor-profile.html">Profile</a></li>
        </ul>
      </nav>
      <button class="logout-btn">Log Out</button>
    </aside>

    <header class="dashboard-header">
      <button class="hamburger-btn" id="hamburger-btn">‚ò∞</button>
      <div class="header-title">Fresh Cart</div>
    </header>

    <div class="content-wrapper">
      <!-- LEFT: Orders list -->
      <main class="content-left">
        <h1 class="page-title">Orders</h1>

        <div class="search-filter-container">
          <input type="text" id="searchInput" placeholder="Search by order # or shop name">
          <select id="statusFilter">
            <option value="all">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="accepted">Accepted</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="declined">Declined</option>
          </select>
        </div>

        <div class="toggle-row">
          <button id="activeOrdersBtn"  class="btn-primary">Active Orders</button>
          <button id="deletedOrdersBtn" class="btn-secondary">Deleted Orders</button>
        </div>

        <div class="order-container" id="order-list"></div>
      </main>

      <!-- RIGHT: Receipt panel (View items) -->
      <aside class="receipt-panel" id="receipt-panel">
        <div class="receipt-title">Order items</div>
        <div class="receipt-meta" id="receipt-meta">Select ‚ÄúView items‚Äù on any order.</div>
        <div class="receipt-items" id="receipt-items"></div>
        <div class="receipt-total" id="receipt-total" style="display:none;">
          <span>Total</span>
          <span id="receipt-total-value">‚Çπ0.00</span>
        </div>
      </aside>
    </div>
  </div>

<script>
  const API_BASE = "https://fresh-cart-backend-5.onrender.com";

  const user = JSON.parse(localStorage.getItem("fc_user") || "{}");

  // DOM references
  const sidebar          = document.getElementById("sidebar");
  const hamburgerBtn     = document.getElementById("hamburger-btn");
  const logoutBtn        = document.querySelector(".logout-btn");

  const orderList        = document.getElementById("order-list");
  const searchInput      = document.getElementById("searchInput");
  const statusFilter     = document.getElementById("statusFilter");

  const receiptPanel     = document.getElementById("receipt-panel");
  const receiptMeta      = document.getElementById("receipt-meta");
  const receiptItems     = document.getElementById("receipt-items");
  const receiptTotal     = document.getElementById("receipt-total");
  const receiptTotalValue= document.getElementById("receipt-total-value");

  let orders = [];
  let autoRefreshTimer = null;

  function formatINR(v) {
    return "‚Çπ" + Number(v || 0).toFixed(2);
  }

  // üîÑ Load distributor orders from backend
  async function loadOrders(animate = false) {
    if (!user.user_id) return;

    try {
      const res = await fetch(`${API_BASE}/distributor/orders/${user.user_id}`);
      if (!res.ok) throw new Error("Failed to fetch orders: " + res.status);
      const data = await res.json();
      orders = Array.isArray(data) ? data : [];
      renderOrders(orders, animate);
    } catch (err) {
      console.error("‚ùå Failed to load orders:", err);
      orderList.innerHTML = `<p style="text-align:center;">Error loading orders.</p>`;
    }
  }

  // üß± Render order cards (left side)
  function renderOrders(newOrders, animate) {
    orderList.innerHTML = "";

    const query  = (searchInput.value || "").toLowerCase();
    const filter = (statusFilter.value || "all").toLowerCase();

    const list = newOrders.filter(o =>
      (filter === "all" || (o.status || "").toLowerCase() === filter) &&
      (String(o.order_id).includes(query) ||
       (o.shop_owner || "").toLowerCase().includes(query))
    );

    if (!list.length) {
      orderList.innerHTML = `<p style="text-align:center;">No matching orders</p>`;
      return;
    }

    list.forEach(order => {
      const div = document.createElement("div");
      const statusSafe = (order.status || "").toLowerCase().replace(/\s+/g, "-");
      const cls = `status-${statusSafe || "pending"}`;

      div.className = "order-card";
      div.innerHTML = `
        <div class="order-header">
          <span>Order #${order.order_id}</span>
          <span class="order-status ${cls}">${order.status || "Pending"}</span>
        </div>
        <div class="order-details">
          <p><strong>Shopkeeper:</strong> ${order.shop_owner || "‚Äî"}</p>
          <p><strong>Date:</strong> ${order.order_date || "‚Äî"}</p>
          <p><strong>Total:</strong> ${formatINR(order.amount)}</p>

          <button class="btn-secondary view-items-btn" data-id="${order.order_id}">
            View Receipt
          </button>

          <div class="action-buttons">
            ${renderButtons(order)}
          </div>
        </div>
      `;
      orderList.appendChild(div);
    });
  }

  // üß† Decide which action buttons to show
  function renderButtons(order) {
    const status = (order.status || "").toLowerCase();
    switch (status) {
      case "pending":
        return `
          <button class="btn-primary" data-action="Accepted" data-id="${order.order_id}">Accept</button>
          <button class="btn-secondary" data-action="Declined" data-id="${order.order_id}">Decline</button>
        `;
      case "accepted":
        return `<button class="btn-primary" data-action="Shipped" data-id="${order.order_id}">Mark Shipped</button>`;
      case "shipped":
        return `<button class="btn-primary" data-action="Out for Delivery" data-id="${order.order_id}">Out for Delivery</button>`;
      case "out for delivery":
        return `<button class="btn-primary" data-action="Delivered" data-id="${order.order_id}">Mark Delivered</button>`;
      default:
        return ""; // delivered / declined
    }
  }

  // üì¶ Load receipt items for a given order
  async function loadReceipt(orderId) {
    const idNum = Number(orderId);
    const order = orders.find(o => Number(o.order_id) === idNum);

    receiptMeta.textContent = `Loading receipt for Order #${orderId}...`;
    receiptItems.innerHTML = "";
    receiptTotal.style.display = "none";

    try {
      const res = await fetch(`${API_BASE}/order_items/${orderId}`);
      const data = await res.json();

      if (!Array.isArray(data) || !data.length) {
        receiptMeta.textContent = `No products found in Order #${orderId}.`;
        receiptItems.innerHTML = "";
        return;
      }

      renderReceipt(orderId, order, data);
    } catch (err) {
      console.error("‚ùå Failed to load order items:", err);
      receiptMeta.textContent = `Failed to load receipt for Order #${orderId}.`;
      receiptItems.innerHTML = "";
    }
  }

  // üßæ Render receipt on the right panel
  function renderReceipt(orderId, order, items) {
    const safeOrder = order || {};
    let total = 0;

    const rowsHtml = items.map((it, idx) => {
      const name =
        it.product_name ||
        it.subproduct_name ||
        it.name ||
        `Item ${idx + 1}`;

      const qty   = Number(it.quantity || it.qty || 0);
      const unit  = it.unit || it.unit_name || "";
      const price = Number(it.price || it.price_per_unit || it.rate || 0);
      const line  = qty * price;
      total += line;

      return `
        <div class="receipt-row">
          <div class="receipt-name">
            ${idx + 1}. ${name}
          </div>
          <div class="receipt-meta-line">
            ${qty || ""} ${unit || ""} ${price ? `√ó ${formatINR(price)}` : ""} ${line ? `= ${formatINR(line)}` : ""}
          </div>
        </div>
      `;
    }).join("");

    receiptMeta.innerHTML = `
      Order #${orderId}<br>
      Shop Owner: ${safeOrder.shop_owner || "‚Äî"}<br>
      Status: ${safeOrder.status || "Pending"}<br>
      Date: ${safeOrder.order_date || "‚Äî"}
    `;

    receiptItems.innerHTML = rowsHtml;
    receiptTotalValue.textContent = formatINR(safeOrder.amount || total);
    receiptTotal.style.display = "flex";

    receiptPanel.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // üîÅ Update status (Accept, Shipped, etc.)
  async function updateStatus(orderId, status) {
    try {
      const res = await fetch(`${API_BASE}/distributor/update_status/${orderId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });
      if (!res.ok) {
        console.error("Status update failed:", await res.text());
      }
    } catch (err) {
      console.error("‚ùå Error updating status:", err);
    }
  }

  // üéõ Event delegation for card buttons
  document.addEventListener("click", async (e) => {
    // View Receipt
    if (e.target.closest(".view-items-btn")) {
      const id = e.target.closest(".view-items-btn").dataset.id;
      loadReceipt(id);
      return;
    }

    // Status action buttons
    const actionBtn = e.target.closest("[data-action]");
    if (actionBtn) {
      const id = actionBtn.dataset.id;
      const status = actionBtn.dataset.action;
      await updateStatus(id, status);
      await loadOrders(true);
    }
  });

  // Filters
  searchInput.addEventListener("input", () => renderOrders(orders));
  statusFilter.addEventListener("change", () => renderOrders(orders));

  // Sidebar + logout
  hamburgerBtn?.addEventListener("click", () => {
    sidebar.classList.toggle("active");
  });

  logoutBtn?.addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "fresh-cart-home.html";
  });

  // Init
  document.addEventListener("DOMContentLoaded", () => {
    loadOrders();
    autoRefreshTimer = setInterval(() => loadOrders(true), 6000);
  });
</script>


</body>
</html>




